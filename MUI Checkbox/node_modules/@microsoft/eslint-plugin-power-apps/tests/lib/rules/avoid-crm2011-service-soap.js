// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

"use strict";

//------------------------------------------------------------------------------
// Requirements
//------------------------------------------------------------------------------

const rule = require("../../../lib/rules/avoid-crm2011-service-soap");
const RuleTester = require("eslint").RuleTester;

//------------------------------------------------------------------------------
// Constants
//------------------------------------------------------------------------------

const MESSAGE_ID = "message2";

//------------------------------------------------------------------------------
// Helpers
//------------------------------------------------------------------------------

const ruleTester = new RuleTester();

ruleTester.run("avoid-crm2011-service-soap", rule, {
    valid: [
        // AbsoluteUri
        `    // VALID: AbsoluteUri
             var webApiService = "https://orgname.crm.dynamics.com/api/data/v8.1/accounts";
             var webApiDisco = "https://disco.crm.dynamics.com/api/discovery/v8.1/Instances";
        `,
        // RelativeUri
        `    // VALID: RelativeUri
             var discoHost = "https://disco.crm.dynamics.com";
             
             var webApiService = Xrm.Page.context.getClientUrl() + "/api/data/v8.1/accounts";
             var webApiDiscoPath = discoHost + "/api/discovery/v8.1/Instances";
        `
    ],
    invalid: [
        // AbsoluteUri
        {
            code:
            `    // INVALID: AbsoluteUri
                 var orgSvcOnlineBase = "http://orgname.crm.dynamics.com/XRMServices/2011/Organization.svc";
                 var orgSvcOnPrem = "http://servername/orgname/XRMServices/2011/Organization.svc";
                 var orgSvcOnlineWeb = "http://orgname.crm.dynamics.com/XRMServices/2011/Organization.svc/Web";
                 var discoSvc = "https://disco.crm.dynamics.com/XRMServices/2011/Discovery.svc";
            `,
            errors: [
                { messageId: MESSAGE_ID, line: 2 },
                { messageId: MESSAGE_ID, line: 3 },
                { messageId: MESSAGE_ID, line: 4 },
                { messageId: MESSAGE_ID, line: 5 }
            ]
        },
        // RelativeUri
        {
            code:
            `    // INVALID: RelativeUri
                 var orgSvcBase = Xrm.Page.context.getClientUrl() + "/XRMServices/2011/Organization.svc";
                 var orgSvcWeb = Xrm.Page.context.getClientUrl() + "/XRMServices/2011/Organization.svc/Web";
                 
                 var discoHost = "https://disco.crm.dynamics.com";
                 var discoSvc = discoHost + "/XRMServices/2011/Discovery.svc";
            `,
            errors: [
                { messageId: MESSAGE_ID, line: 2 },
                { messageId: MESSAGE_ID, line: 3 },
                { messageId: MESSAGE_ID, line: 6 }
            ]
        },
        // AbsoluteUri with unformatted
        {
            code:
                `    // INVALID: AbsoluteUri with messageAsUnformatted
                     var orgSvcOnlineBase = "http://orgname.crm.dynamics.com/XRMServices/2011/Organization.svc";
                     var orgSvcOnPrem = "http://servername/orgname/XRMServices/2011/Organization.svc";
                     var orgSvcOnlineWeb = "http://orgname.crm.dynamics.com/XRMServices/2011/Organization.svc/Web";
                     var discoSvc = "https://disco.crm.dynamics.com/XRMServices/2011/Discovery.svc";
                `,
            errors: [
                { line: 2 },
                { line: 3 },
                { line: 4 },
                { line: 5 }
            ],
            options: [ "unformatted" ]
        },
        // AbsoluteUri with unformatted and different casing
        {
            code:
                `    // INVALID: AbsoluteUri with messageAsUnformatted and different casing
                     var orgSvcOnlineBase = "http://orgname.crm.dynamics.com/XRMservices/2011/organization.svc";
                `,
            errors: [
                { line: 2 },
            ],
            options: [ "unformatted" ]
        },        // RelativeUri with unformatted
        {
            code:
                `    // INVALID: RelativeUri with messageAsUnformatted
                     var orgSvcBase = Xrm.Page.context.getClientUrl() + "/XRMServices/2011/Organization.svc";
                     var orgSvcWeb = Xrm.Page.context.getClientUrl() + "/XRMServices/2011/Organization.svc/Web";
                     
                     var discoHost = "https://disco.crm.dynamics.com";
                     var discoSvc = discoHost + "/XRMServices/2011/Discovery.svc";
                `,
            errors: [
                { line: 2 },
                { line: 3 },
                { line: 6 }
            ],
            options: [ "unformatted" ]
        }
    ]
});
